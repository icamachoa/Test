<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="es">
<head>

  <#include doc="estilo_usuario.dbsp"/>
  <#include doc="scripts_popups.dbsp"/>
   <script src="/scripts/ajaxForm/AjaxForm.js" type="text/javascript" ></script>
  <title>SalesUp! - Producto</title>
<style>
  Tabs.ui-tabs .ui-tabs-panel{padding:0;}
  .BoxInfo.w100, .BoxInfo.w50{height:27px;}
  input.w50 {height: 23px !important;}
  div.InfoData{margin-left: 0 !important;}
  .BoxDoc{ height: 90px !important;}
  .imgtam {height: 60px; width: 80px;}
  .mostrar{display:block;}
  .espacio{margin-top: 5px;}
  #Tabs{margin-top: 0px;}
  selectize-dropdown-content{max-height:60px!important;}
  .selectize-input.not-full.has-options > input {float:left;}
  .selectize-control.multi .selectize-input [data-value]{float:left;}
  .selectize-control.multi .selectize-input [data-value]{background:#d1e5f5!important;}
  .selectize-control.multi .selectize-input > div{border:1px solid #4673b7;color:#4673b7;}
  .selectize-control.plugin-remove_button [data-value] .remove{border-left: 0px solid #4673b7;}
  .selectize-control.multi .selectize-input > div.active {border: 1px solid #4673b7;}
  .naranja{background-color:#F90 !important;color:#FFF}
  .porcentaje{font-size:14px;font-weight:bold;position:absolute;top:1px;z-index:5;right:10px;}
  .pimpuesto{font-size: 14px;font-weight: bold;position: absolute;top:8px;z-index:5;right:10px;}
  .Activo{display: block;}
  .Inactivo{display: none;}
  .Acciones {margin-top: 5px !important;}
  .verde{color:green;}
  .BoxDoc .fa-times{display: none;}
  .BoxDoc.ArchivoSeleccionado .fa-check{display:none;}
  .BoxDoc.ArchivoSeleccionado .fa-times{display: inline-block;}
  .Posicion {position: relative;}
  .Separacion {clear: both; padding-top: 15px;}
  .Pmoneda {font-size: 9px; position: absolute; top: 8px;
            z-index: 5;  right: 10px; color: #666; font-style: oblique}
  .altotxtarea{height: 114px !important;}
  #popup-contenedor {padding: 3px 10px 45px 10px;}
</style>
</head>
<body id="popup-contenedor">
<div id="Espera"></div>
<form name="Frmproducto" id="Frmproducto" method="post" enctype="multipart/form-data" action="Modelo/jsonMovimientosProductos.dbsp">  <!--Modelo/jsonMovimientosProductos.dbsp-->
<input  type="hidden" id ="multimoneda" value="<#SESSION.MULTIMONEDA/>"/>
<input type="hidden"     id="objImg"   name="imagen1"/>
<input type="hidden"     id="montobase" name="montobase" />
<input type="hidden"     id="img_default" name="img_default"/>
<input type="hidden"     id="imagen1"  class="imgNombre" data-defaul="0" />
<input type="hidden"     id="imagen2"  class="imgNombre" data-defaul="0"/>
<input type="hidden"     id="imagen3"  class="imgNombre" data-defaul="0"/>
<input type="hidden"     id="imagen4"  class="imgNombre" data-defaul="0"/>
<input type="hidden"     id="imagen5"  class="imgNombre" data-defaul="0"/>
<input type="hidden"     id="imagen6"  class="imgNombre" data-defaul="0"/>
<input type="hidden"     id="imagen7"  class="imgNombre" data-defaul="0"/>
<input type="hidden"     id="imagen8"  class="imgNombre" data-defaul="0"/>
<input type="hidden"     id="imagen9"  class="imgNombre" data-defaul="0"/>
<input type="hidden"     id="imagen10"  class="imgNombre" data-defaul="0"/>
<input type="hidden"  name="banidproducto" id="banidproducto" value="<#idProducto/>"/>
<input type="hidden"     name="tkproducto" value="<#tk/>"/>
<input type="hidden"  id="separadorDecimal"  value="<#SP_DECIMALSEPARATOR/>"/> 
<input type="hidden"  id="descripCotizacion" name="descripCotizacion" value="" />
<div id="Tabs">
  <ul>
    <li><a href="#general" id="gral" onclick="self.parent.SalesUp.Sistema.CambiarTamanioPopUp({Ancho:800});">Datos generales</a></li>
    <li><a href="#imagenes" id="TabImg" onclick="self.parent.SalesUp.Sistema.CambiarTamanioPopUp({Alto:320,Ancho:800});">Imágenes</a></li>
    <li><a href="#descripcion" onclick="self.parent.SalesUp.Sistema.CambiarTamanioPopUp({Alto:500 , Ancho:800});">Descripción</a></li>
  </ul>   
  <div id="general">
            <div class="BoxInfo w100">
                 <div class="w100"><label class="InfoLabel Tip1" tip="Descripción">Nombre*</label><input type="text" class="InfoData InfoObligatorio" name="nombre" id="nombre" autofocus="true" /></div>
            </div>  
              <!-- <div class="BoxInfo w100"> -->
                 <div class="BoxInfo w50"><label class="InfoLabel Tip1" tip="Código">Código*</label><input class="InfoData InfoObligatorio" onchange="SalesUp.Variables.ValidarDuplicidadCodigo({c:value, t:this});" onblr="SalesUp.Variables.ValidarDuplicidadCodigo({c:value, t:this});" type="text" name="codigo" id="codigo" /></div>
                 <div class="BoxInfo w50">
                      <label class="InfoLabel">Existencia*</label>
                      <div class="InfoData w100">
                        <select id="selectexistencia" name="selectexistencia" class="w100" onchange="SalesUp.Variables.HabilitarExistenciaTexto(value);">
                          <option value="-1">Ilimitada</option>
                          <option value="2">Manual</option>
                        </select>             
                        <input type="text" id="existencia" name="existencia" onblur="SalesUp.Variables.numerosDecimales({t:this});" onkeypress="return SalesUp.Valida.valDecimales({e:event, t:this, v:value});" class="w50" style="display:none;" >
                      </div>
                 </div>
          <!--    </div>   -->
            
                <!--name="idlinea" idmarca se cambiaron por Tks-->
                 <div class="BoxInfo w50"><label class="InfoLabel Tip1" tip="Linea">Línea*</label><select  id="selectlinea" class="InfoObligatorio" name="tklinea" placeholder="Selecionar línea"  ></select>  </div>
                 <div class="BoxInfo w50"><label class="InfoLabel Tip1" tip="Marca">Marca*</label><select id="selectMarca" class="InfoObligatorio" name="tkmarca" placeholder="Seleccionar marca" ></select></div>
           

             
                 <div class="BoxInfo w50"><label class="InfoLabel">Unidades*</label><input class="InfoData InfoObligatorio" type="text" name="unidad" id="unidad" /></div>

                 <div class="BoxInfo w50"><label class="InfoLabel">Costo*</label><input type="text" class="InfoData InfoObligatorio" name="costo"  onblur="SalesUp.Variables.numerosDecimales({t:this});" onkeypress="return SalesUp.Valida.valDecimales({e:event, t:this, v:value});" onchange="SalesUp.Variables.ValidarPrecios({v:value, t:this});"  id="costo"/><span class="Pmoneda Mlocal"></span></div>
          

            

             <div class="TitDiv Separacion"> <i class="fa  fa-angle-double-right"></i> Precios</div>

             <!--=============LLENADO DINÁMICO ============-->
             <div id="Ltprecios" class="w100">
               <div class="w50 BoxInfo"><label class="InfoLabel Tip1  Pminimo LongMoneda"  tip="Precio mínimo" ondblclick="SalesUp.Variables.establecerMontosComisionDblClick({t:this})">Mínimo*</label><input type="text" class="InfoData InfoObligatorio" name="preciominimo" id="preciominimo" onkeypress="return SalesUp.Valida.valDecimales({e:event, t:this, v:value});"  onchange="SalesUp.Variables.establecerMontosComision({v:value, t:this});SalesUp.Variables.PreciosSugeridos({v:value, t:this});" onblur="SalesUp.Variables.establecerMontosComision({v:value, t:this});SalesUp.Variables.numerosDecimales({t:this});"/><span class="Pmoneda Mlocal"></span></div> 

             </div>  
             <!--=============LLENADO DINÁMICO============-->  
             <!--<div id="MsgInfo" class="SinResultados espacio BoxSizing w100" ><i clas="fa fa-circle-info"></i><span class="texto"></span></div>-->
  <div class="clear"></div>
  </div>  <!--=============Class General============-->
  <div id="imagenes">
       <div id="imgcontenedor" class="w100">
        
        <div id="prearchivo1" class="w20 p10">
            <div id="pre-archivo1" class=" imagenes BoxDoc p10 w100 tCen BoxSizing Transition BoxCarpetaVacia" onclick="SalesUp.Variables.AbreAgregaImagen({v:1});">
              <i class="Pointer fa fa-3x fa-file-picture-o" ></i><p class="DocDescripcion Ellipsis w100">Agregar</p><div class="clear">
            </div>
        </div>  
        </div>
        <div id="prearchivo2" class="w20 p10">
            <div id="pre-archivo2" class=" imagenes BoxDoc p10 w100 tCen BoxSizing Transition BoxCarpetaVacia" onclick="SalesUp.Variables.AbreAgregaImagen({v:2});">
              <i class="Pointer fa fa-3x fa-file-picture-o"></i><p class="DocDescripcion Ellipsis w100">Agregar</p><div class="clear"></div>
            </div>
        </div>
        <div id="prearchivo3" class="w20 p10">
            <div id="pre-archivo3" class=" imagenes BoxDoc p10 w100 tCen BoxSizing Transition BoxCarpetaVacia" onclick="SalesUp.Variables.AbreAgregaImagen({v:3});">
              <i class="Pointer fa fa-3x fa-file-picture-o"></i><p class="DocDescripcion Ellipsis w100">Agregar</p><div class="clear"></div>
            </div>
        </div>
        <div id="prearchivo4" class="w20 p10">
            <div id="pre-archivo5" class=" imagenes BoxDoc p10 w100 tCen BoxSizing Transition BoxCarpetaVacia" onclick="SalesUp.Variables.AbreAgregaImagen({v:4});">
              <i class="Pointer fa fa-3x fa-file-picture-o"></i><p class="DocDescripcion Ellipsis w100">Agregar</p><div class="clear"></div>
            </div>
        </div>
        <div id="prearchivo5" class="w20 p10">
            <div id="pre-archivo5" class=" imagenes BoxDoc p10 w100 tCen BoxSizing Transition BoxCarpetaVacia" onclick="SalesUp.Variables.AbreAgregaImagen({v:5});">
              <i class="Pointer fa fa-3x fa-file-picture-o"></i><p class="DocDescripcion Ellipsis w100">Agregar</p><div class="clear"></div>
            </div>
        </div> 
         <div id="prearchivo6" class="w20 p10">
            <div id="pre-archivo6" class=" imagenes BoxDoc p10 w100 tCen BoxSizing Transition BoxCarpetaVacia" onclick="SalesUp.Variables.AbreAgregaImagen({v:6});">
              <i class="Pointer fa fa-3x fa-file-picture-o"></i><p class="DocDescripcion Ellipsis w100">Agregar</p><div class="clear"></div>
            </div>
        </div> 
        <div id="prearchivo7" class="w20 p10">
            <div id="pre-archivo7" class=" imagenes BoxDoc p10 w100 tCen BoxSizing Transition BoxCarpetaVacia" onclick="SalesUp.Variables.AbreAgregaImagen({v:7});">
              <i class="Pointer fa fa-3x fa-file-picture-o"></i><p class="DocDescripcion Ellipsis w100">Agregar</p><div class="clear"></div>
            </div>
        </div> 
        <div id="prearchivo8" class="w20 p10">
            <div id="pre-archivo8" class=" imagenes BoxDoc p10 w100 tCen BoxSizing Transition BoxCarpetaVacia" onclick="SalesUp.Variables.AbreAgregaImagen({v:8});">
              <i class="Pointer fa fa-3x fa-file-picture-o"></i><p class="DocDescripcion Ellipsis w100">Agregar</p><div class="clear"></div>
            </div>
        </div>         
        <div id="prearchivo9" class="w20 p10">
            <div id="pre-archivo9" class=" imagenes BoxDoc p10 w100 tCen BoxSizing Transition BoxCarpetaVacia" onclick="SalesUp.Variables.AbreAgregaImagen({v:9});">
              <i class="Pointer fa fa-3x fa-file-picture-o"></i><p class="DocDescripcion Ellipsis w100">Agregar</p><div class="clear"></div>
            </div>
        </div> 
        <div id="prearchivo10" class="w20 p10">
            <div id="pre-archivo10" class=" imagenes BoxDoc p10 w100 tCen BoxSizing Transition BoxCarpetaVacia" onclick="SalesUp.Variables.AbreAgregaImagen({v:10});">
              <i class="Pointer fa fa-3x fa-file-picture-o"></i><p class="DocDescripcion Ellipsis w100">Agregar</p><div class="clear"></div>
            </div>
        </div>         
      </div><!--imgcontenedor -->

  </div><!--=============Class imagenes============-->
  <div id="descripcion">
  <div class="clear"></div>

  <div class="">
  <div class="clear"></div>
  <div class="TitDiv "> <i class="fa  fa-angle-double-right"></i> Descripción corta</div>
     <textarea  class="DescripcionProducts w100 BoxSizing InfoData " style="height: 114px !important;" name="desc_extendida1" id="desc_extendida1"></textarea>
  </div>
   <div class="clear"></div>
  <div >
    <div class="TitDiv"> <i class="fa  fa-angle-double-right"></i>  Descripción extendida</div>
     <textarea  class=" DescripcionProd" name="desc_extendida2" id="desc_extendida2"></textarea>
  </div>

  </div>
</div><!--=============Class tabs============-->
           <div class="BoxBotonesAccion w100">
                <button type="button" id="BtnAceptar" class="Btn Btn-rounded Btn-small Btn-tiny Btn-tiny-min Btn-flat-Aceptar" onclick="SalesUp.Variables.GuardarDatos();">
                      <i class="fa fa-check"></i> Agregar 
                </button>
                <button type="button" id="BtnCancelar" class="Btn Btn-rounded Btn-small Btn-flat-Cancelar" onclick="self.parent.tb_remove();">
                      <i class="fa fa-times"></i> Cancelar 
                    </button>
          </div><!--=============Class BoxBotonesAccion============-->
</form>
<!--=======formulario sube imagen amazon=====-->
    <form id="FrmSubirImg" name="FrmSubirImg"  enctype="multipart/form-data" method="post" action="https://fenix.salesup.com.mx/aws/subeArchivos.php" style="display:none;"> <!--action=""https://fenix.salesup.com.mx/aws/subeArchivos.php-->
      <input name="idempresa" id="idempresa" type="hidden" value="<#SESSION.IDEMPRESA/>">
      <input name="tipo" id="tipo" type="hidden" value="PROD">
      <input name="publico" id="publico" type="hidden" value="1">
      <input name="archivo[]" id="archivo1" class="imgarch ArchivoImagen" type="file" onchange="SalesUp.Variables.ObtieneNombImg({v:value, t:this, id:1});"  data-Imagen="0" >
      <input name="archivo[]" id="archivo2" class="imgarch ArchivoImagen" type="file" onchange="SalesUp.Variables.ObtieneNombImg({v:value, t:this, id:2});"  data-Imagen="0">
      <input name="archivo[]" id="archivo3" class="imgarch ArchivoImagen"  type="file" onchange="SalesUp.Variables.ObtieneNombImg({v:value, t:this, id:3});" data-Imagen="0">
      <input name="archivo[]" id="archivo4" class="imgarch ArchivoImagen" type="file" onchange="SalesUp.Variables.ObtieneNombImg({v:value, t:this, id:4});"  data-Imagen="0">
      <input name="archivo[]" id="archivo5" class="imgarch ArchivoImagen" type="file" onchange="SalesUp.Variables.ObtieneNombImg({v:value, t:this, id:5});"  data-Imagen="0">
      <input name="archivo[]" id="archivo6" class="imgarch ArchivoImagen" type="file" onchange="SalesUp.Variables.ObtieneNombImg({v:value, t:this, id:6});"  data-Imagen="0">
      <input name="archivo[]" id="archivo7" class="imgarch ArchivoImagen" type="file" onchange="SalesUp.Variables.ObtieneNombImg({v:value, t:this, id:7});"  data-Imagen="0">
      <input name="archivo[]" id="archivo8" class="imgarch ArchivoImagen" type="file" onchange="SalesUp.Variables.ObtieneNombImg({v:value, t:this, id:8});"  data-Imagen="0">
      <input name="archivo[]" id="archivo9" class="imgarch ArchivoImagen" type="file" onchange="SalesUp.Variables.ObtieneNombImg({v:value, t:this, id:9});"  data-Imagen="0">
      <input name="archivo[]" id="archivo10" class="imgarch ArchivoImagen" type="file" onchange="SalesUp.Variables.ObtieneNombImg({v:value, t:this, id:10});" data-Imagen="0">
    </form>

<!--============-->


<script src="/privado/Controlador/IniciaPopUps.js<#RTIME/>"></script>
<script>
SalesUp.Producto={};
SalesUp.Producto.Tk='<#tk/>';
SalesUp.Variables.IdEmpresa='<#SESSION.IDEMPRESA/>';
var $selectLineasProductos, $selectMarcasProductos;
SalesUp.Variables.NombreImgAEliminar=[];
var arrImg=[0,0,0,0,0,0,0,0,0,0];

var SysSepDecimales = SalesUp.Sistema.Almacenamiento({a:'SysSepDecimales'});

//=============================================================================

Handlebars.registerHelper('Num', function(i) {
return parseInt(i)+1;
});
Handlebars.registerHelper('indice', function(index, respuesta) {
 respuesta=index+1;
return respuesta;
});
//=============================================================================


SalesUp.Variables.EnviarFormulario=function(){
  var imgeliminar=SalesUp.Variables.NombreImgAEliminar;
  var contimg=0;
  var  $img=$('.imgarch');
  for(var i = 0; i <=$img.length - 1; i++) {
    if($($img[i]).val()!=''){contimg++;}
  };
  if(SalesUp.Producto.Tk!=''){
    for(var i = 0; i <=imgeliminar.length   -1; i++) {
      SalesUp.Sistema.CargaDatos({Link:'https://fenix.salesup.com.mx/aws/eliminaArchivo.php', Parametros: 'archivo='+imgeliminar[i]+'&idempresa='+SalesUp.Variables.IdEmpresa});
    }
  }
  if(contimg>0){
    AjaxFormSimple();
    $('#FrmSubirImg').submit();
  }else{
    SalesUp.Variables.establecerValoresInputImagen();
    setTimeout(function() { 
    SalesUp.Variables.AplicarReduccionImgPorDefecto();
    SalesUp.Variables.ValidaPreciosSubmit();
    $('#Frmproducto').submit();
    }, 500);
  }
  
}
SalesUp.Variables.ValidarImangePorDefecto=function(){
  var TieneDefault=false;
  var contadorImg=0;
  var posicion;
  var idprod=$('#banidproducto').val();
  if(idprod==0){
    $('.imgarch').each(function(){
      var valor= $(this).val();
      if(valor!=''){
          contadorImg++;
      }
    });
  }else{
    $('.imgNombre').each(function(){
      var valor= $(this).val();
      if(valor!=''){
          contadorImg++;
      }
    });
  }
  if(contadorImg==1){
      var i=$('.conImg');
      var elem=$('.conImg').find('img').attr('id');
      var pos=elem.substring(11);
      // var YaExiste=$('.imgNombre[data-defaul=1]');
      $('#imagen'+pos).attr('data-defaul', 1);      
      TieneDefault=true;
    }else if(contadorImg>1){
      $('.imgNombre').each(function(i){
        var valor=$(this).attr('data-defaul');
        var id=$(this).attr('id');
        if(valor==1){
          TieneDefault=true;
        }
      });
    if(!TieneDefault){
      SalesUp.Construye.MuestraMsj({tMsg:4, Destino:'body', Id:'ArchivosValidos', Msg:'Debe seleccionar una imagen por defecto.' });
      $('#TabImg').click();
      $('.BoxDoc.conImg').addClass('DatoMal'); 
    }
  }else{
      TieneDefault=true;
    }


  return TieneDefault;
}
SalesUp.Variables.GuardarDatos=function(){
  SalesUp.Sistema.MuestraEspera('', 4);
  setTimeout(function() {
    var pasa=SalesUp.Valida.ValidaObligatorios();
        (pasa)? pasa=SalesUp.Variables.ValidarImangePorDefecto():'';
        var codigo=$('#codigo').val();
        (pasa)?pasa=SalesUp.Variables.ValidarDuplicidadCodigo({c:codigo, t:$('#codigo').val()}):'';
       //Habilitar para validar precios
    if(pasa){
      SalesUp.Variables.EnviarFormulario();  
    }else{
      SalesUp.Sistema.OcultarOverlay();
    }
  }, 500); 
}

SalesUp.Variables.ValidaPreciosSubmit=function(){
  
    $('#preciominimo').val(SalesUp.Variables.QuitaFormato($('#preciominimo').val()));
    
    $('#costo').val(SalesUp.Variables.QuitaFormato($('#costo').val()));

    $('.InputPrecio').each(function(){
      $(this).val(SalesUp.Variables.QuitaFormato($(this).val()));
    });
      
      
    $('.ComisionValor').each(function(){
      $(this).val(SalesUp.Variables.QuitaFormato($(this).val()));
    });
     
    $('.ImpuestoValor').each(function(){
      $(this).val(SalesUp.Variables.QuitaFormato($(this).val()));
    });
      
}

SalesUp.Variables.ValidarPrecioMinimoIgualMayorCosto=function(Op){
  var resultado=true;
  var valor=(Op.v)?Op.v:''; 
  var elemento=(Op.t)?Op.t:'';
  var tc = parseFloat($(elemento).attr('data-tipocambio'));
  valor = valor * tc;
  var costo=$('#costo').val();
  if(parseFloat(valor)<parseFloat(costo)){
     SalesUp.Construye.MuestraMsj({tMsg:4, Destino:'body', Id:'ArchivosValidos', Msg:'El precio mínimo no puede ser menor al costo' });
     SalesUp.Valida.MarcarObligatorio($(elemento));
      SalesUp.Valida.FocusMal();
     //$(elemento).focus();
     resultado=false;
  }
  return resultado;
}
$(window).load(function(){
  
  if($('[name="tkproducto"]').val() != ""){
    $('.InputPrecio').parent().find('label.naranja').dblclick();
  }else{
    $('.InputPrecio:first').parent().find('label').dblclick();  
  }
})
  

$('#Frmproducto #selectlinea' ).change(function(){
  if($('[name="tkproducto"]').val() != ""){
    return false;
  }else{

    var PonerComision =  function(Obj,err){
      if(err){return 0;}
      var comision = Obj.jsonDatos[0].COMISION;
      $('#Frmproducto .ComisionValor').each(function(){
        if(parseFloat($(this).attr('data-original')) === 0){
          $(this).val(SalesUp.Variables.FormatoMonedaLocal(comision));
        };
      })  
    }
    SalesUp.Sistema.CargaDatosAsync({link:'/privado/modelo/jsonLineasProductoTk.dbsp',parametros:'tk='+$('#Frmproducto #selectlinea').val(),callback:PonerComision});
  }
})



//========= funciones Imagenes ==========//
SalesUp.Variables.establecerValoresInputImagen=function(){
  var objImagenes=[];
  $('.imgNombre').each(function(){
     var Elemento=this; 
     var nombre=Elemento.id; 
     var valor=Elemento.value;
     var pordefecto=$(Elemento).attr('data-defaul');
     imagenes={
       'nombre':nombre , 
       'valor':valor , 
       'pordefecto':pordefecto
     }
      objImagenes.push(imagenes); 
  });
  var datos=JSON.stringify(objImagenes); 
  $('#objImg').val('');
  $('#objImg').val(datos);
}

SalesUp.Variables.AbreAgregaImagen=function(Op){
    var id=(Op.v)?Op.v:'';
    var p=SalesUp.Variables.obtenerPosicionImagen({id:id});
    $('#archivo'+p).attr('data-imganterior'); 
    $('#archivo'+p).click(); 
}

SalesUp.Variables.obtenerPosicionImagen = function(){
  var posicion;
  for (var i=0; i<=arrImg.length-1; i++){
     var valorArrImg=arrImg[i];
     if(valorArrImg==0){
       posicion=i;
       break; 
     }
    }
   return posicion+1;
} 

SalesUp.Variables.ValidarPrecios=function(Op){
  if(!SalesUp.Variables.numerosDecimales({t:Op.t})){return;}
  var elemento=(Op.t)?Op.t:''; 
  var valor=(Op.v)?Op.v:''; 
  var evento=(Op.e)?Op.e:''; 
  var cercano=$(elemento).prev();
  var EsIndicador=$(cercano).hasClass('naranja');
  (EsIndicador)?   SalesUp.Variables.establecerMontosComision({v:valor,t:elemento}) :'';
  var idempresamonedaLocal = parseInt($('#preciominimo').attr('data-idempresamoneda'));
  var tipocambioLocal = parseFloat($('#preciominimo').attr('data-tipocambio'));
  var idempresamonedaValidar = parseInt($(elemento).attr('data-idempresamoneda'));
  var tipocambioValidar = parseFloat($(elemento).attr('data-tipocambio'));
  var precioMinimo=$('#preciominimo').val();
  var precioTxt = SalesUp.Sistema.FormatoMoneda($('[name="costo"]').val());
  $('#preciominimo').attr('placeholder','Precio mínimo: '+precioTxt);
  $('#preciominimo').change();
    if(idempresamonedaLocal == idempresamonedaValidar){
        if(parseFloat(valor)<parseFloat(precioMinimo)){
          SalesUp.Construye.MuestraMsj({tMsg:4, Destino:'body', Id:'ArchivosValidos', Msg:'El precio no puede ser menor al precio mínimo' });
          //$(elemento).focus();
          SalesUp.Valida.MarcarObligatorio($(elemento));
          SalesUp.Variables.PreciosNoValidos=false;
      }
    }else{
      var nuevoPrecioConvertido = SalesUp.Variables.ConversorMoneda(tipocambioValidar,tipocambioLocal, valor);
        if(parseFloat(nuevoPrecioConvertido)<parseFloat(precioMinimo)){
          SalesUp.Construye.MuestraMsj({tMsg:4, Destino:'body', Id:'ArchivosValidos', Msg:'El precio no puede ser menor al precio mínimo' });
          //$(elemento).focus();
          SalesUp.Valida.MarcarObligatorio($(elemento));
          SalesUp.Variables.PreciosNoValidos=false;
      }
    }
}

SalesUp.Variables.ExtensionesPermitidas = function(){
        var ExtPermintidas = [];
        var Imagenes = ['jpg','png','jpeg','gif'];
        ExtPermintidas = _.union(Imagenes);
        SalesUp.Variables.ExtPermintidas = SalesUp.Sistema.StrReplace(',','|',ExtPermintidas.toString());
        return ExtPermintidas;
}/*ExtensionesPermitidas*/
SalesUp.Variables.ValidaExtension = function(Op){
        var Pasa = true;
        var Archivo = Op.Archivo.toLowerCase();
        
        if(Archivo){
          var Ext = Archivo.split('.').pop();
          var Extensiones = SalesUp.Variables.ExtensionesPermitidas();
          
          if(Extensiones.indexOf(Ext)<0){
            SalesUp.Construye.MuestraMsj({tMsg:4, Destino:'body', Id:'ArchivosValidos', Msg:'Extensión inválida. Sólo imágenes' });
            Pasa = false;
          }
        }
        return Pasa;
}/*ValidaExtension*/

SalesUp.Variables.ObtenerImagen=function(Op) {
         var input=(Op.t)?Op.t:'';
         var id=(Op.id)?Op.id:'';
         var img='img-'+id;
         var posision=(Op.p)?Op.p:'';
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
               Imgbase64=e.target.result;
              $('#'+img).attr('src', e.target.result);
              $('#archivo'+posision).attr('data-Imagen', e.target.result);
               arrImg[posision-1]=1;
            }
            reader.readAsDataURL(input.files[0]);
        }
}

SalesUp.Variables.SeleccionarImagenPorDefecto=function(Op){
   var indice=(Op.p)?Op.p:'';
     SalesUp.Construye.MuestraAlerta({
      TipoAlerta:'AlertaPregunta',
      Alerta:'<h2 class="Rojo"><i class="fa fa-warning "></i> Atención</h2><br/> La imagen se va a reducir, está de acuerdo?',
      Boton1:'Aceptar',
      Boton2:'Cancelar',
      Callback1:'SalesUp.Variables.AceptarReducirImg({id:\''+indice+'\'})',
      Icono1:'<i class="fa fa-trash"></i>',
      Icono2:'<i class="fa fa-times"></i>',
      Ancho:'250px'
    });
   

   
}
SalesUp.Variables.AceptarReducirImg=function(Op){
    var indice=(Op.id)?Op.id:'';
    if(indice==''){return;}
   $('.ArchivoSeleccionado').removeClass('ArchivoSeleccionado');
   $('#prearchivo'+indice).find('.BoxDoc').addClass('ArchivoSeleccionado');
   $('.imgNombre').attr('data-defaul', 0);
   $('#imagen'+indice).attr('data-defaul', 1);
   $('.BoxDoc.conImg').removeClass('DatoMal');


}
SalesUp.Variables.AplicarReduccionImgPorDefecto=function(){
    var ImgPorDefecto=$('.imgNombre[data-defaul=1]').val();
    var carpeta=SalesUp.Sistema.CargaDatos({Link:'Modelo/jsonObtieneCarpeta.dbsp', DataType:'json'});
        carpeta=carpeta.jsonDatos[0].CARPETA;
     var Url='https://fenix.salesup.com.mx/aws/CopiaobtieneImagenProductoB64.php?url='+carpeta+'/'+ImgPorDefecto;    
    var Imgb64=SalesUp.Sistema.CargaDatos({Link:Url});    
    $('#img_default').val(Imgb64);

}
/*Etoy aqui**/
SalesUp.Variables.CancelarImgporDefecto=function(Op){
  var contador=0;
  $('.imgNombre').each(function(){
      var valor=$(this).val();
      if(valor!=''){
        contador++;
      }    
  });
  if(contador==0 || contador==1){
  }else{
  }
  // $('.ArchivoSeleccionado').removeClass('ArchivoSeleccionado');
  // $('.imgNombre').attr('data-defaul', 0);
}
SalesUp.Variables.ObtieneNombImg=function(Op){
      var $selector=(Op.t)?$(Op.t):'';
      var Nombre=(Op.v)?Op.v:'';
      var posicion=(Op.id)?Op.id:'';
      if(Nombre.length<=0){return;}
      var Extension=SalesUp.Variables.ValidaExtension({Archivo:Nombre});
      if(!Extension){return;}
      var id=$selector.attr('id'); 
      var html =''; 
          html +='<div class=" ContImagenes Transition  BoxDoc tCen w100 conImg"><img class="imgtam" id="img-archivo'+posicion+'" height="50" ></img><div class="clear"> </div>'
          html +='<div  id="acciones'+posicion+'" class="Acciones"><span tip="Eliminar archivo" class="Pointer Tip1" onclick="SalesUp.Variables.ConfirmaEliminarArchivo({id:'+posicion+'})" >'
          html +=' <i class="fa fa-lg fa-trash-o"> </i></span> <span id="seleccionImg'+posicion+'" onclick="SalesUp.Variables.SeleccionarImagenPorDefecto({p:'+posicion+', t:this});" class="Tip5 Pointer" tip="Selecciona la imagen por defecto"><i class="fa fa-lg fa-check"></i></span>'
          html +='<span id="cancelarDef'+posicion+'" onclick="SalesUp.Variables.CancelarImgporDefecto({p:'+posicion+', t:this});" class="Tip5 Pointer " tip="Cancelar la imagen por defecto"><i class="fa fa-lg fa-tmes"></i></span></div></div>';
      $("#pre"+id).html(html);
      SalesUp.Variables.ObtenerImagen({t:Op.t, id:id, p:posicion});
      var imganterior=$('#'+id).attr('data-imganterior');
      SalesUp.Sistema.IniciaPlugins();
}
SalesUp.Variables.ConfirmaEliminarArchivo=function(Op){
  var id= (Op.id)?Op.id:'';
  SalesUp.Construye.MuestraAlerta({
    TipoAlerta:'AlertaPregunta',
    Alerta:'<h2 class="Rojo"><i class="fa fa-warning "></i> Atención</h2><br/> ¿Desea eliminar la imágen '+id+'?',
    Boton1:'Aceptar',
    Boton2:'Cancelar',
    Callback1:'SalesUp.Variables.EliminarArchivo({id:\''+id+'\'})',
    Icono1:'<i class="fa fa-trash"></i>',
    Icono2:'<i class="fa fa-times"></i>',
    Ancho:'250px'
  });
}// fin ConfirmarElimianrArchivo.
SalesUp.Variables.EliminarArchivo=function(Op){
    var id=(Op.id)?Op.id:'';
    arrImg[id-1]=0;
    if(SalesUp.Variables.idProducto>0){
      var NombreEliminar=$('#archivo'+id).attr('data-imganterior');
      SalesUp.Variables.NombreImgAEliminar.push(NombreEliminar);
    }
    
    $("#prearchivo"+id).html('<div id="pre-archivo'+id+'" class=" imagenes BoxDoc p10 w100 tCen BoxSizing Transition BoxCarpetaVacia" onclick="SalesUp.Variables.AbreAgregaImagen({v:'+id+'});"><i class="Pointer fa fa-3x fa-file-picture-o"></i><p class="DocDescripcion Ellipsis w100">Agregar imagen '+id+'</p><div class="clear"></div>');
    $('#imagen'+id).attr('src', '');
    $('#imagen'+id).val('');
    $('#archivo'+id).attr('data-imganterior', '');
    $('#archivo'+id).attr('data-imagen', 0);
    $('#imagen'+id).attr('data-defaul', 0);
}
function AjaxFormSimple(Op){
          var OptionesAjaxForm = { 
          beforeSend: function(){
          },uploadProgress: function(event, position, total, percentComplete){
          },success: function(){}
          ,complete: function(response){
            var json = JSON.parse(response.responseText);
            SalesUp.Variables.CrearInputsImg({datos:json});
          },error: function(e){
        
          }
        }        
          $("#FrmSubirImg").ajaxForm(OptionesAjaxForm);   
}

SalesUp.Variables.CrearInputsImg=function(Op){
   var jsonImagenes={};
   var jsonDatos=(Op.datos)?Op.datos:'';
       resultado=jsonDatos.resultado;
   var datos=jsonDatos.datos; 
    var hay = 0;
    if(resultado==1){
       var arrImgNombre = $('.imgNombre');
       for (var i =0; i <datos.length; i++) {
         for (var ix = 0; ix < _.size(arrImgNombre); ix++){
            var $input = $(arrImgNombre[ix]);
            if($input.val()==''){
              $input.val(datos[i].nombre);
              ix=10;
            }
          }
       }
    }
  
  SalesUp.Variables.establecerValoresInputImagen();
  setTimeout(function() { SalesUp.Variables.ValidaPreciosSubmit(); SalesUp.Variables.AplicarReduccionImgPorDefecto();$('#Frmproducto').submit();}, 500);
}

SalesUp.Variables.FormatoMonedaLocal = function (Numero){
  
    var MonedaFormato='%s%v';
    var SysMoneda = '';
      SysMoneda = SalesUp.Sistema.StrReplace('.','', SysMoneda);
      SysMoneda = SalesUp.Sistema.StrReplace(',','', SysMoneda);
    var SysFormatoMoneda = SalesUp.Sistema.Almacenamiento({a:'SysFormatoMoneda'});
    var SysSepMiles = SalesUp.Sistema.Almacenamiento({a:'SysSepMiles'});
    var SysSepDecimales = SalesUp.Sistema.Almacenamiento({a:'SysSepDecimales'});
    
    (!SysSepMiles)?SysSepMiles=',':'';
    (!SysSepDecimales)?SysSepDecimales='.':'';
    (!SysFormatoMoneda)?SysFormatoMoneda=0:'';
    (SysFormatoMoneda==0)?MonedaFormato='%s%v':'';
    (SysFormatoMoneda==1)?MonedaFormato='%v%s':'';
    (SysFormatoMoneda==2)?MonedaFormato='%s %v':'';
    (SysFormatoMoneda==3)?MonedaFormato='%v %s':'';

    return accounting.formatMoney(Numero, SysMoneda, 2, SysSepMiles, SysSepDecimales, MonedaFormato);
  }



SalesUp.Variables.PreciosSugeridos=function(Op){
  var idempresamonedaLocal = parseInt($('#preciominimo').attr('data-idempresamoneda'));
  var tipocambioLocal = parseFloat($('#preciominimo').attr('data-tipocambio'));
  var valor=(Op.v)?Op.v:''; 
  var cantidad = parseInt(valor);

  
  valor=SalesUp.Sistema.FormatoMoneda(SalesUp.Variables.QuitaFormato(valor));
  $('.Sugerido').each(function(){
      var idempresamonedaValidar = parseInt($(this).attr('data-idempresamoneda'));
      var tipocambioValidar = parseFloat($(this).attr('data-tipocambio'));
      var valorInput = $(this).val();
      if(idempresamonedaLocal == idempresamonedaValidar){
         var texto='Precio mínimo: '+ valor;   
        if(valorInput != ''){
              if(parseInt(valorInput)<cantidad){
                $(this).val('');
                $(this).attr('placeholder', texto);
              }
            }else{
                $(this).attr('placeholder', texto);    
            }
      }
      else{
      var nuevoPrecioConvertido = SalesUp.Variables.ConversorMoneda(tipocambioLocal,tipocambioValidar, cantidad);
       var texto='Precio mínimo: '+ SalesUp.Sistema.FormatoMoneda(nuevoPrecioConvertido);
          if(valorInput != ''){
              if(parseInt(valorInput)<nuevoPrecioConvertido){
                $(this).val('');
                $(this).attr('placeholder', texto);
              }
            }else{
                $(this).attr('placeholder', texto);    
            }      
    }

  });

}


SalesUp.Variables.HabilitarExistenciaTexto=function(value){
          if(value==-1){
               $("#existencia").hide(450);
              setTimeout(function(){$("#selectexistencia").addClass('w100').removeClass('w50');$("#existencia").val(-1);}, 501);
            }else if(value==2){
              $("#selectexistencia").addClass('w50').removeClass('w100');
              $("#existencia").show(450).val('').focus();    
            }
}



SalesUp.Variables.llenaInputsLineasProducto=function(Op){
    var ValorId=$(Op.id)?Op.id:'';
    var datos=SalesUp.Sistema.CargaDatos({Link:'Modelo/jsonConsultarLineasProductos.dbsp',  DataType:'json'});
        datos = datos.jsonDatos;
    var Activos=_.reject(datos, function(j){ return j.STATUS==0;});
   $selectLineasProductos= $('#selectlinea').selectize({
          maxItems:1,
          plugins: ['remove_button'],
          options:Activos,
          valueField:'TK',
          searchField:['LINEA_PRODUCTO'],
          labelField:'LINEA_PRODUCTO',
          sortField:'LINEA_PRODUCTO'

     });
    $('.selectize-control').addClass('InfoData');
    var selectizeLinea = $selectLineasProductos[0].selectize;
    (ValorId!='')? selectizeLinea.setValue(ValorId) :'';
    
   
}

SalesUp.Variables.llenaInputsMarcas=function(Op){
      var ValorId=$(Op.id)?Op.id:'';
      var datos=SalesUp.Sistema.CargaDatos({Link:'Modelo/jsonConsultarMarcasProductos.dbsp',  DataType:'json'});
          datos = datos.jsonDatos;

      var Activos=_.reject(datos, function(j){ return j.STATUS==0;});
      $selectMarcasProductos=$('#selectMarca').selectize({
          maxItems:1,
          options:Activos,
          valueField:'TK',
          searchField:['MARCA'],
          labelField:'MARCA',
          sortField:'MARCA'

      });
      $('.selectize-control').addClass('InfoData');
       var selectizeMarca = $selectMarcasProductos[0].selectize;
      (ValorId!='')? selectizeMarca.setValue(ValorId) :'';
      
}

SalesUp.Variables.llenaInputs=function(){
      var data=SalesUp.Sistema.CargaDatos({Link:'Modelo/jsonConsultarPrecios.dbsp',  DataType:'json'});
      data.jsonDatos=_.sortBy(data.jsonDatos, 'INDX');
      data.jsonDatos = _.reject(data.jsonDatos , function(j){ return _.size(j) == 0; });
      jsondatos=data.jsonDatos;
      var template='{{#each jsonDatos}}<div class="BoxInfo w50 EstadoActual" data-status="{{STATUS}}"><label class="InfoLabel Pointer Tip1 precios{{indx}} {{NOMBRE}}" data-idprecio="{{IDLISTA_PRECIO}}" tip="{{NOMBRE}}" ondblclick="SalesUp.Variables.establecerMontosComisionDblClick({t:this});">{{NOMBRE}}</label> <input type="text" class="InfoData Sugerido InputPrecio" data-idempresamoneda="{{IDEMPRESAMONEDA}}"  data-tipocambio="{{TIPODECAMBIO}}" onkeypress="return SalesUp.Valida.valDecimales({e:event, t:this, v:value});"  onchange="SalesUp.Variables.ValidarPrecios({v:value, t:this, e:event});" onblur="SalesUp.Variables.ValidarPrecios({v:value, t:this, e:event});" name="{{INDICE}}" id="{{INDICE}}"/><span class="Pmoneda">{{IDMONEDA}}</span></div>{{/each}}';
      var response=SalesUp.Construye.ReemplazaDatos({Template:template, Datos: data});
      $("#Ltprecios").append(response);
     
 }
SalesUp.Variables.llenaComisiones=function(){
  var respuesta=SalesUp.Sistema.CargaDatos({Link:'Modelo/jsonConsultarProdutosComisiones.dbsp', Parametros:'', DataType:'json'});
      respuesta.jsonDatos = _.reject(respuesta.jsonDatos , function(j){ return _.size(j) == 0; });
      respuesta=respuesta.jsonDatos; 
  var total=_.size(respuesta); 
  var html='<div class="TitDiv Separacion"> <i class="fa  fa-angle-double-right"></i> Comisiones e impuestos</div>';
  for(var i=0; i<=respuesta.length-1; i++){
      var r=respuesta[i];
      var descripcion=r.DESCRIPCION; 
      var idComision=r.IDPRODUCTO_COMISION;
      var status=r.STATUS;
      var indice=r.INDICE;
      var monto=r.MONTO;
         monto=monto*100;
         monto=parseFloat(monto).toFixed(2);
      var cantidadComision = SalesUp.Variables.ComisionMonto(indice);
      html+='<div class="BoxInfo w50  EstadoActual" data-status="'+status+'"><label class="InfoLabel Tip1" tip="'+descripcion+'">'+descripcion+'</label><div class="InfoData">'
          +'<div class="w50 Posicion pr5"><input type="text" class="BoxSizing  InfoData w100 ComisionValor" data-original="'+SalesUp.Variables.FormatoMonedaLocal(monto)+'" onkeypress="return SalesUp.Valida.valDecimales({e:event, t:this, v:value});"  onchange="SalesUp.Variables.establecerComisionMonto({v:value, p:'+(indice)+'});" name="comision'+(indice)+'" id="comision'+(indice)+'" data-id="'+idComision+'" value="'+SalesUp.Variables.FormatoMonedaLocal(monto)+'">'
          +'<span class="porcentaje">%</span></div>'
          +'<div class="w50"><input type="text" class="BoxSizing InfoData w100 ComisionPct" name="comisionpct'+(indice)+'" onkeypress="return SalesUp.Valida.valDecimales({e:event, t:this, v:value});"  onchange="SalesUp.Variables.establecerPorcentajeComision({v:value, t:this, i:'+(indice)+'});" id="comisionpct'+(indice)+'" data-id="'+idComision+'" value="'+cantidadComision+'" ></div></div></div>';
  }
   $('#Ltprecios').append(html); 
}

SalesUp.Variables.ComisionMonto = function(indice){
  var porcentajeComision = $('#comision'+indice).val();
      porcentajeComision = SalesUp.Sistema.quitarFormatoNumero(porcentajeComision);
      porcentajeComision = porcentajeComision/100;
  var costoTotal = $('#costo').val();
      costoTotal = SalesUp.Sistema.quitarFormatoNumero(costoTotal);
  var comision = costoTotal*porcentajeComision;
      comision = SalesUp.Sistema.formatoNumero(comision);
  return comision;
}

SalesUp.Variables.llenaImpuestos=function(){
    var respuesta=SalesUp.Sistema.CargaDatos({Link:'Modelo/jsonConsultarProdutosImpuestos.dbsp', Parametros:'', DataType:'json'});
        respuesta.jsonDatos = _.reject(respuesta.jsonDatos , function(j){ return _.size(j) == 0; });
        respuesta=respuesta.jsonDatos; 
    var total=_.size(respuesta); 
    var html='';
    for(var i=0; i<=respuesta.length-1; i++){
        var r=respuesta[i];
        var nombre=r.IMPUESTO;
        var id=r.IDIMPUESTO;
        var indice=r.INDICE;
        var tasa=r.TASA;
            tasa=(tasa*100).toFixed(2); 

        var status=r.STATUS;
        html+='<div class="BoxInfo w50 EstadoActual"  data-status="'+status+'"><label class="InfoLabel Tip1" tip="'+nombre+'">'+nombre+'</label>'
            +'<input type="text" class=" InfoData ImpuestoValor Posicion" onkeypress="return SalesUp.Valida.valDecimales({e:event, t:this, v:value});"  name="impuesto'+(indice)+'" onblur="SalesUp.Variables.numerosDecimales({t:this});" id="impuesto'+(indice)+'" data-id="" value="'+SalesUp.Variables.FormatoMonedaLocal(tasa)+'"><span class="pimpuesto">%</span></div></div>'
    }
    $('#Ltprecios').append(html);  
}
SalesUp.Variables.numerosDecimales = function(Op){ 
  var expresion=/(?:\d*\.)?\d+/;
  var $t = $(Op.t);
  var num = $t.val();
  var esDecimal = (num!='') ? expresion.test(num) : true;
  var mensaje = 'Soló se permiten <strong>números decimales</strong>';
  if(!esDecimal){
      SalesUp.Construye.MuestraMsj({tMsg:4, Destino:'body', Msg:mensaje });
      SalesUp.Valida.MarcarObligatorio($t);
      SalesUp.Valida.FocusMal();
    return esDecimal;
  }
  return esDecimal;
}

SalesUp.Variables.llenaEditar=function(tk){
        var data=SalesUp.Sistema.CargaDatos({Link:'Modelo/jsonProductosEditar.dbsp',Parametros:'tk='+tk, DataType:'json'});
        data=data.jsonDatos;
        var montoBase=data[0].MONTO_BASE;
        var img_def=data[0].IMG_DEFAULT;

        $('.naranja').removeClass('naranja');
        if(montoBase=='preciominimo'){
          $('.Pminimo').addClass('naranja');
        }else{
          $('label[data-idprecio="'+montoBase+'"]').addClass('naranja');
        }
        $('#codigo').val(data[0].CODIGO);
        $('#nombre').val(data[0].NOMBRE);
        SalesUp.Variables.llenaInputsLineasProducto({id:data[0].TKLINEAPROD});
        SalesUp.Variables.llenaInputsMarcas({id:data[0].TKMARCA});
        $('#preciominimo').val(SalesUp.Variables.FormatoMonedaLocal(data[0].PRECIO_MIN));
        $('#costo').val(SalesUp.Variables.FormatoMonedaLocal(data[0].COSTO));
        $('#unidad').val(data[0].UNIDAD);
        if((data[0].EXISTENCIA==-1)){
           $("#existencia").hide(450);
           setTimeout(function(){$("#selectexistencia").addClass('w100').removeClass('w50');$('#selectexistencia').val(-1);$('#existencia').val(-1);}, 501);
        }else{
          $("#selectexistencia").addClass('w50').removeClass('w100').val(2);
          setTimeout(function() {$('#existencia').show(450).val(data[0].EXISTENCIA);}, 1005);
        }
        $('#desc_extendida1').val(data[0].DESCRIPCION_EXTENDIDA1);
        $('#desc_extendida2').val(data[0].DESCRIPCION_EXTENDIDA2);
        $('#descorta').val(data[0].DESCRIPCION_CORTA);
         var elemento=$('.naranja').next(); 
         var valor=$(elemento).val();
          for (var i=1; i<11; i++){
            var precio=data[0]['PRECIO'+i];
            precio =parseFloat(precio).toFixed(2);
            var comision=data[0]['COMISION'+i];
           // comision=(parseFloat(comision)*100).toFixed(2);
            var impuesto=data[0]['IMPUESTO'+i];
            //impuesto=(parseFloat(impuesto)*100).toFixed(2);
            $('#precio'+i).val(SalesUp.Variables.FormatoMonedaLocal(precio));
            $('#comision'+i).val(SalesUp.Variables.FormatoMonedaLocal(comision));
            $('#impuesto'+i).val(SalesUp.Variables.FormatoMonedaLocal(impuesto));
          }
         $('#img_default').val(img_def);
         var elemento=$('.naranja').next(); 
         var valor=$(elemento).val();
         SalesUp.Variables.establecerMontosComision({v:valor, t:elemento});
         var objimagenes=data[0].IMAGENES; 
         var Img=$('.imgNombre');
         $('.imgNombre').attr('data-defaul', 0);
        if(objimagenes){
            objimagenes=JSON.parse(objimagenes);
            var url='https://s3-us-west-2.amazonaws.com/salesupfiles/'+data[0].CARPETA+'/';
            for(var i=0; i<=objimagenes.length-1; i++){
                var nombre=objimagenes[i].nombre;
                var valor=objimagenes[i].valor; 
                var defecto=objimagenes[i].pordefecto;
                var Seleccionado=(defecto==1)?  'ArchivoSeleccionado' : '';
                var ruta=url+valor;
                var id='prearchivo'+(i+1);

                $('#'+nombre).attr('data-defaul', defecto);
                if(valor!=''){
                  $('#archivo'+(i+1)).attr('data-imganterior', valor);
                  var html =''; 
                      html +='<div class=" ContImagenes '+Seleccionado+' Transition  BoxDoc tCen w100 conImg"><img class="imgtam" id="img-archivo'+(i+1)+'" height="50" src="'+ruta+'"></img><div class="clear"> </div>'
                      html +='<div  id="acciones'+(i+1)+'" class="Acciones"><span tip="Eliminar archivo" class="Pointer Tip1" onclick="SalesUp.Variables.ConfirmaEliminarArchivo({id:'+(i+1)+'})" >'
                      html +=' <i class="fa fa-lg fa-trash-o"> </i></span> <span id="seleccionImg'+(i+1)+'" onclick="SalesUp.Variables.SeleccionarImagenPorDefecto({p:'+(i+1)+', t:this});" class="Tip5 Pointer" tip="Selecciona la imagen por defecto"><i class="fa fa-lg fa-check"></i></span>'
                      html +='<span id="cancelarDef'+(i+1)+'" onclick="SalesUp.Variables.CancelarImgporDefecto({p:'+(i+1)+', t:this});" class="Tip5 Pointer " tip="Cancelar la imagen por defecto"><i class="fa fa-lg fa-tmes"></i></span></div></div>';
                  $("#"+id).html(html);
                }
                $('#imagen'+(i+1)).val(valor);
            }
            

        }
        var arrImgNombre = $('.imgNombre');
        for (var ix = 0; ix < _.size(arrImgNombre); ix++){
          var $input = $(arrImgNombre[ix]);
          var n = ix;
          arrImg[n] = 0;
          if($input.val()!=''){
            arrImg[n] = 1;
          }
        }
}

SalesUp.Variables.SinFormato=function(Op){
  var v=(Op.v)?Op.v:'';
  var SysSepDecimales = SalesUp.Sistema.Almacenamiento({a:'SysSepDecimales'});
  return accounting.unformat(v, SysSepDecimales);
}

SalesUp.Variables.establecerPorcentajeComision=function(Op){
   var elemento=(Op.t)?Op.t:''; 
   var valor=(Op.v)?SalesUp.Variables.QuitaFormato(Op.v):''; 
   var i=(Op.i)?Op.i:'';
   var MontoActivo=$('.naranja').next().val(); 
    MontoActivo = SalesUp.Sistema.quitarFormatoNumero(MontoActivo);
   if (valor > 0 && MontoActivo === 0) {
    $(elemento).val(0);
    $('.naranja').next().focus();
    SalesUp.Construye.MuestraMsj({tMsg:4, Destino:'body', Id:'ArchivosValidos', Msg:'Imposible calcular, introduzca precio base' });
    return false;
   }
   var valorPorcentaje=(valor/MontoActivo)*100;
   $('#comision'+i).val(valorPorcentaje.toFixed(2));


   if (valor > 0 && MontoActivo === 0) {
    $(elemento).val(0);
    $('.naranja').next().focus();
    SalesUp.Construye.MuestraMsj({tMsg:4, Destino:'body', Id:'ArchivosValidos', Msg:'Imposible calcular, introduzca precio base' });
    return false;
   }

   var valorPorcentaje=(valor/MontoActivo)*100;
   valorPorcentaje = (isNaN(valorPorcentaje)) ? 0 : valorPorcentaje;
   valorPorcentaje = SalesUp.Sistema.formatoNumero(valorPorcentaje);
   $('#comision'+i).val(valorPorcentaje);
}

SalesUp.Variables.establecerMontosComision=function(Op){  
  var monto=(Op.v)?Op.v:0;
  var elemento=(Op.t)?Op.t:''; 
  var respuesta=SalesUp.Variables.ValidarPrecioMinimoIgualMayorCosto({t:elemento, v:monto});
      //respuesta=true;//(respuesta)  ? SalesUp.Variables.ValidarLongitudNumero({v:monto, t:elemento}) :'';
  if(respuesta){
    var id=$(elemento).prev().attr('data-idprecio');
        id=(id)?id:$(elemento).attr('id');
        var Monto=$('.naranja').next().val();
    $('#montobase').val(id);
    $('.ComisionValor').each(function(i){
      
       var elemento=this;
       var nombre=this.name; 
       var valorComision=SalesUp.Variables.SinFormato({v:this.value});
       valorComision=valorComision/100;
       var total=parseFloat(SalesUp.Variables.QuitaFormato(Monto))*valorComision;
       var i=i+1;
       $('#comisionpct'+i).val(SalesUp.Variables.FormatoMonedaLocal(total.toFixed(2)));
    });
  }
}

SalesUp.Variables.QuitaFormato = function(value){
  
  var v   = value;
  
  v = accounting.unformat(value, SysSepDecimales)

  if(!v)return 0 
  else return v;
}


SalesUp.Variables.establecerComisionMonto=function(Op){

  var comision =(Op.v)?Op.v:0; 
      comision = SalesUp.Sistema.quitarFormatoNumero(comision);
      comision=comision/100;
  var indice=(Op.p)?Op.p:'';
  var Monto=$('.naranja').next().val();
      Monto = SalesUp.Sistema.quitarFormatoNumero(Monto);
  var precioMinimo=(Monto)?Monto:0; 
  var total=precioMinimo*comision;
     if(isNaN(total)){total=0;}
      total = SalesUp.Sistema.formatoNumero(total); 
  $('#comisionpct'+indice).val(total);
}


SalesUp.Variables.establecerMontosComisionDblClick=function(Op){  
  var x=$('.naranja');
  $(x).removeClass('naranja');
  var elemento=(Op.t)?Op.t:'';
  var ElementoSiguiente=$(elemento).next();
  $(elemento).addClass('naranja'); 
  var valor=$(ElementoSiguiente).val();
  SalesUp.Variables.establecerMontosComision({v:valor, t:ElementoSiguiente});
}
//No se esa utlizando.
SalesUp.Variables.establecerSimboloMoneda=function(Op){
  return;
  var elemento=(Op.t)?Op.t:'';
  var valor=(Op.v)?Op.v:0; 
  var simboloMoneda='';
      simboloMoneda=localStorage.SysMoneda; 
      valor=simboloMoneda.concat(valor); 
      valor=valor.substring(1);
  $(elemento).val(valor);
}
SalesUp.Variables.OcultarElementosInactivos=function(){
  var contador=0; 
  var Incremento=30;
  var total=0;
  $('.EstadoActual').each(function(i){
    var Estado=$(this).attr('data-status');
    (Estado==0)? $(this).hide().addClass('Inactivo') : $(this).addClass('Activo');
  });
}
SalesUp.Variables.ContadorElementosActivos=function(){
  var contador=1; 
  var Incremento=27; 
  var Total=0; 
  $('.Activo .InputPrecio').each(function(i){ contador++; });
  if (contador%2==1) contador++;

  $('.Activo .ComisionPct').each(function(i){  contador++; });
  if (contador%2==1) contador++;
  
  $('.Activo .ImpuestoValor').each(function(i){ contador++; });
  if (contador%2==1) contador++;
  
  contador = contador / 2;
  Total=Incremento*contador;
  return Total;
}

SalesUp.Variables.ValidarLongitudNumero=function(Op){
  var resultado=true;
  var $t=$(Op.t);
  var numero=(Op.v)?Op.v:''; 
  var expReg=/^\d{0,15}$/
  var r=expReg.test(numero); 
  if(!r){
   SalesUp.Construye.MuestraMsj({tMsg:4, Destino:'body', Id:'', Msg:'Longitud máxima 15.' });
   //SalesUp.Sistema.MarcarObligatorio($t);
  }
  return r;
}

self.parent.SalesUp.Sistema.CambiarTamanioPopUp({Alto:290, Ancho:800});
$(function(){

  var AltoPantalla=290;

  // fija monedas locales
  var monedaLocal = SalesUp.Sistema.Almacenamiento({a:'SysMonedaDefault'});
  if (monedaLocal == undefined) monedaLocal = '';
  $('.Mlocal').html(monedaLocal);


  var datosMoneda = SalesUp.Sistema.CargaDatos({Link:'Modelo/jsonObtieneMonedaLocal.dbsp', Parametros: 'IDMONEDA='+monedaLocal, DataType:'json'}).jsonDatos;

  var idempresamoneda = datosMoneda[0].IDEMPRESAMONEDA;
  var tipocambio = datosMoneda[0].TIPODECAMBIO;

  $('#preciominimo').attr('data-idempresamoneda',idempresamoneda);
  $('#preciominimo').attr('data-tipocambio',tipocambio);

  SalesUp.Variables.llenaInputs({});
  SalesUp.Variables.llenaComisiones();
  SalesUp.Variables.llenaImpuestos();
  SalesUp.Variables.OcultarElementosInactivos();
  var IncrementoPantalla=SalesUp.Variables.ContadorElementosActivos();
  AltoPantalla=(AltoPantalla==0)? AltoPantalla : AltoPantalla+=IncrementoPantalla;
  self.parent.SalesUp.Sistema.CambiarTamanioPopUp({Alto:AltoPantalla});
  $('#gral').attr('onclick', 'self.parent.SalesUp.Sistema.CambiarTamanioPopUp({Alto:'+AltoPantalla+', Ancho:800});');
  $("#Tabs").tabs();
  ActivaTinyDescripcionProductos();
  if(!_.isEmpty(SalesUp.Producto.Tk)){
    
     $('#BtnAceptar').html('<i class="fa fa-check"></i> Guardar');
     $('#banidproducto').val(1);
     SalesUp.Variables.llenaEditar(SalesUp.Producto.Tk); 
  }else{
     SalesUp.Variables.HabilitarExistenciaTexto();
     SalesUp.Variables.llenaInputsMarcas({});
     SalesUp.Variables.llenaInputsLineasProducto({});
     
     var existencia=$('#selectexistencia').val();
     $('#existencia').val(existencia);
  }
  SalesUp.Sistema.IniciaPlugins();
  $('.Pminimo').addClass('naranja');

});

SalesUp.Variables.ValidarDuplicidadCodigo=function(Op){
  var resultado=true;
  var codigo=(Op.c)?Op.c:'';
  var elemento=(Op.t)?Op.t:'';
  if(!_.isEmpty(SalesUp.Producto.Tk)){return resultado;}else  if(codigo!=''){
    var datos=SalesUp.Sistema.CargaDatos({Link:'Modelo/jsonValidarDuplicidadCodigo.dbsp', Parametros:'codigo='+codigo, DataType:'json'}).jsonDatos;  
    var res=datos[0].TOTAL;
    if(res==1){
      SalesUp.Construye.MuestraMsj({tMsg:4, Destino:'body', Id:'ArchivosValidos', Msg:'Ya existe el código, por favor ingrese uno diferente' });
      SalesUp.Valida.MarcarObligatorio($(elemento));
      resultado=false;
    }
  }
  return resultado;
}

SalesUp.Variables.ConversorMoneda = function (base,nuevo, monto){
  var cantidad = 0;
 
  if(base < nuevo){
    cantidad = base/nuevo*monto;
  }else{
    cantidad = ((1/nuevo)*base)*monto;
  }
      
    return SalesUp.Variables.roundDos(cantidad);
}

SalesUp.Variables.roundDos = function (num) {
  return +(Math.round(num + "e+2")  + "e-2");
}
  /*Cambios realizados 10/feb/2016*/
  
  </script>
  </body>
</html>





