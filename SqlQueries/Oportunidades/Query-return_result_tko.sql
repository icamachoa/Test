//[tkcom|Text,descartado|Integer,session.idusuario|Untyped,porempresa|Text,porcatalogo|Text,session.db|Untyped,session.idempresa|Untyped,idpantalla|Integer,]
--SELECT 
DECLARE @IDCOMPANIA INT
DECLARE @IDUSUARIO INT
DECLARE @DESCARTADO TINYINT
DECLARE @F_USUARIO VARCHAR(MAX)
DECLARE @SQL VARCHAR(MAX)
DECLARE @TkCom VARCHAR(128)
DECLARE @CRIT VARCHAR(MAX)
DECLARE @POREMPRESA VARCHAR(MAX)
DECLARE @PORCATALOGO VARCHAR(MAX)
SET @TkCom = ISNULL(:TKCOM,'')
SET @DESCARTADO= ISNULL(:DESCARTADO,0)
SELECT @IDCOMPANIA = 0
SET @IDUSUARIO = CAST('<#SESSION.IDUSUARIO/>' AS INT)
SET @POREMPRESA = ISNULL(:POREMPRESA,'')
SET @PORCATALOGO =  ISNULL(:PORCATALOGO,'')



SET @IDUSUARIO = <#SESSION.IDUSUARIO/>
DECLARE @IDPANTALLA VARCHAR(MAX)
SET @IDPANTALLA = ISNULL(:IDPANTALLA,2)
DECLARE @IDEMPRESA VARCHAR(MAX)
SET @IDEMPRESA = <#SESSION.IDEMPRESA/>



DECLARE @TABLADEFILTROS TABLE(ID INT, VAL VARCHAR(MAX))

--------

SET @TkCom = CAST(ISNULL(:TKCOM,' ')  AS VARCHAR(MAX))

DECLARE @PORTKCOM VARCHAR(MAX)
SET @PORTKCOM = ''
--DECLARE @IDCOMPANIA INT;
--SET @IDCOMPANIA = 0
IF @TkCom != ''
BEGIN
   --SELECT @IDCOMPANIA  = IDCOMPANIA FROM <#SESSION.DB/>.dbo.COMPANIAS WHERE TKCOM = @TkCom
   SET @PORTKCOM = ' AND COM.TKCOM = '''+CAST(@TkCom AS VARCHAR(MAX))+''' '
END
-----------
INSERT INTO @TABLADEFILTROS
SELECT * FROM <#SESSION.DB/>.dbo.filtrospantallas(@IDPANTALLA, @IDEMPRESA, @IDUSUARIO)

SELECT
  @CRIT = <#SESSION.DB/>.DBO.UDF_CONSTRUYE_FILTRO(@IDUSUARIO, CAST(RTRIM(LTRIM(@IDPANTALLA)) AS int))
SELECT
    @CRIT = @CRIT + <#SESSION.DB/>.DBO.UDF_CONSTRUYE_FILTRO(@IDUSUARIO, 15)



  SELECT @F_USUARIO = VAL
  FROM @TABLADEFILTROS
  WHERE ID = 1

  
  SELECT @DESCARTADO = VAL
  FROM @TABLADEFILTROS
  WHERE ID = 3
 

  IF @F_USUARIO IS NOT NULL AND @TKCOM != ''
  BEGIN
    DECLARE @IDSUSUARIOS VARCHAR(MAX)
    SET @IDSUSUARIOS = ''
    SELECT @IDSUSUARIOS=CAST(ID AS VARCHAR(1000))+','+@IDSUSUARIOS FROM <#SESSION.DB/>.DBO.ObtieneUsuariosAutorizadosModulos (@IDUSUARIO,@IDPANTALLA,0)
    SET @IDSUSUARIOS=@IDSUSUARIOS+'0'
    SET @F_USUARIO = 'AND ( (O.IDUSUARIO IN  ('+@IDSUSUARIOS+')))'
  END


SET @SQL='
USE <#SESSION.DB/>
DECLARE @TkCom VARCHAR(128)
DECLARE @IDCOMPANIA INT
DECLARE @IDUSUARIO INT
DECLARE @DESCARTADO TINYINT
SET @DESCARTADO= ISNULL('+CAST(@DESCARTADO as varchar(1000))+',0)
SET @IDUSUARIO =  ISNULL('+CAST(@IDUSUARIO AS VARCHAR(1000))+',0)
SELECT @IDCOMPANIA = 0
IF '''+@TkCom+''' != ''''
BEGIN
	 SELECT @IDCOMPANIA = IDCOMPANIA FROM <#SESSION.DB/>.dbo.COMPANIAS WHERE TKCOM = '''+@TkCom+'''
END


SELECT 
  DISTINCT P.TKP  AS TKP
 
FROM <#SESSION.DB/>.dbo.OPORTUNIDADES O WITH(NOLOCK)
  LEFT JOIN <#SESSION.DB/>.dbo.DOCUMENTO_ICONOS WITH(NOLOCK) ON O.ARCHIVO != '''' AND EXTENSION = <#SESSION.DB/>.dbo.obtiene_extension(ARCHIVO)
  LEFT JOIN <#SESSION.DB/>.dbo.PROSPECTOS_SEGUIMIENTO S WITH(NOLOCK) ON O.IDULTIMOSEGUIMIENTO=S.IDSEGUIMIENTO 
  LEFT JOIN <#SESSION.DB/>.dbo.USUARIOS U1 WITH(NOLOCK) ON S.IDUSUARIO=U1.IDUSUARIO
  JOIN  <#SESSION.DB/>.dbo.PROSPECTOS P WITH(NOLOCK) ON O.IDPROSPECTO = P.IDPROSPECTO
  LEFT JOIN <#SESSION.DB/>.dbo.PROSPECTOS_ASIGNADOS PA WITH(NOLOCK) ON '+CAST (@IDUSUARIO AS  VARCHAR(1000))+' = PA.IDUSUARIO AND PA.IDPROSPECTO = O.IDPROSPECTO
  LEFT JOIN <#SESSION.DB/>.DBO.PROSPECTOS_ASIGNADOS PA2 WITH(NOLOCK) ON PA2.IDPROSPECTO = P.IDPROSPECTO AND PA2.IDUSUARIO = '+CAST(@IDUSUARIO AS VARCHAR(1000))+'
  LEFT JOIN <#SESSION.DB/>.DBO.PROSPECTOS_ASIGNADOS A3 WITH(NOLOCK) ON A3.IDPROSPECTO = P.IDPROSPECTO AND P.IDUSUARIO != A3.IDUSUARIO
  LEFT JOIN <#SESSION.DB/>.dbo.COMPANIAS COM ON COM.IDCOMPANIA = P.IDCOMPANIA, 
  <#SESSION.DB/>.dbo.OPORTUNIDADES_FASES F WITH(NOLOCK), <#SESSION.DB/>.dbo.USUARIOS U WITH(NOLOCK), <#SESSION.DB/>.dbo.EMPRESAS_LINEAS_PRODUCTO LP WITH(NOLOCK)


WHERE 
  O.PERDIDA=0 
  AND O.GANADA = 0 
  '+@F_USUARIO+' 
  AND P.DESCARTADO=0 
  AND O.IDUSUARIO = U.IDUSUARIO 
  AND O.IDFASE = F.IDFASE 
  AND O.IDLINEA_PRODUCTO = LP.IDLINEA_PRODUCTO 
  AND P.IDEMPRESA = <#SESSION.IDEMPRESA/>
  '+@CRIT+'
  '+@POREMPRESA+'
  '+@PORCATALOGO+'
  '
  
  EXEC (@SQL)
